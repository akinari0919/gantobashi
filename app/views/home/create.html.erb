<%= render 'layouts/header' %>

<main>
  <div class="create-contents">
    <div class="camera">
      <video class="camera-bd" id="video" autoplay playsinline width="300" height="300"></video>
      <canvas class="camera-bd" id="canvas" width="300" height="300"></canvas>
    </div>  
    <div class="btn">
      <a class="button-41" role="button" id="shatter" onclick="init()">ガン飛ばす</a>
      <a class="button-42" id="dummy">解析中...</a>
    </div>
    <div class="comment">
      <div id="label-container"></div>
      <div id="result"></div>
    </div>
    <div class="btn-2">
      <a class="button-40" role="button" id="reload" onclick="window.location.reload();">撮り直す</a>
      <a class="button-40" role="button" id="detail" onclick="window.location.reload();">詳細</a>
    </div>
  </div>
</main>

<%= render 'layouts/footer' %>

<p><button id="lock">Click</button></p>

<script>
  $('#canvas').hide();
  $('#dummy').hide();
  $('#reload').hide();
  $('#detail').hide();
  // カメラ設定
  const constraints = {
    video: {
      width: 300,
      height: 300,
      facingMode: "user"   // フロントカメラを利用する
    }
  };

  // カメラを<video>と同期
  navigator.mediaDevices.getUserMedia(constraints)
  .then( (stream) => {
    video.srcObject = stream;
    video.onloadedmetadata = (e) => {
      video.play();
    };
  })
  .catch( (err) => {
    console.log(err.name + ": " + err.message);
  });

  const URL = "https://teachablemachine.withgoogle.com/models/3tSiNOSPs/";

  let model, labelContainer, maxPredictions;

  async function init() {
    document.getElementById('shatter').disabled = true;
    $('#video').hide();
    $('#shatter').hide();
    $('#canvas').show();
    $('#dummy').show();
    $(this).html( $(this).data('loading-text') );
    
    // canvasに静止画を入れる
    var canvas = document.getElementById("canvas")
    canvas.getContext("2d").drawImage(video, 0, 0, 300, 300)

    // teachablemachineのモデルURLを読み込む
    const modelURL = URL + "model.json";
    const metadataURL = URL + "metadata.json";

    // モデルのイメージを格納する
    model = await tmImage.load(modelURL, metadataURL);
    maxPredictions = model.getTotalClasses();

    // 結果を出す為のlavelcontainerをDOMに要素追加する
    labelContainer = document.getElementById("label-container");
    window.requestAnimationFrame(loop);
  }

  async function loop() {
    // 予測は、画像、ビデオ、またはキャンバスのhtml要素を取り込むことができます
    const prediction = await model.predict(canvas);

    // predictionの数値によって結果を変える
    if (prediction[0].probability.toFixed(2)> 0.1) {
      const base64 = canvas.toDataURL('image/jpeg').replace(/data:.*\/.*;base64,/, '');
      $.ajax({
        url: '/check',
        type: 'POST',
        data: {
            image: base64
          },
        headers: {
            'X-CSRF-Token' : $('meta[name="csrf-token"]').attr('content')
          },
        success: function(data) {
            $(result).append(data);
          }
      })
    } else {
      $(labelContainer).html('それじゃいかん！')
    }
    $('#dummy').hide();
    $('#reload').show();
    $('#detail').show();
  }

function requestFullScreen(elem) {
  if (elem.requestFullScreen) {
    elem.requestFullScreen();
  }
  else if (elem.webkitRequestFullScreen) {
    elem.webkitRequestFullScreen();
  }
  else if (elem.mozRequestFullScreen) {
    elem.mozRequestFullScreen();
  }
  else if (elem.msRequestFullScreen) {
    elem.msRequestFullScreen();
  }
}

function lockOrientation(mode) {
  if (screen.orientation.lock) {
    screen.orientation.lock(mode);
  }
  else if (screen.lockOrientation) {
    screen.lockOrientation(mode);
  }
  else if (screen.webkitLockOrientation) {
    screen.webkitLockOrientation(mode);
  }
  else if (screen.mozLockOrientation) {
    screen.mozLockOrientation(mode);
  }
  else if (screen.msLockOrientation) {
    screen.msLockOrientation(mode);
  }
}

document.addEventListener("DOMContentLoaded", function(){

  document.getElementById("lock").onclick = function(){
    // html全体をフルスクリーン化します
    requestFullScreen(document.documentElement);
    // 縦画面に固定します
    // screen.orientation.lockは即座に効くようですが、
    // screen.lockOrientation系は少し間を開けないと有効にならないようです
    setTimeout(function(){
        lockOrientation("portrait");
    }, 1);

    return false;
  };
}, false);

</script>
